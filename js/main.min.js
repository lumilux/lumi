(function(){var a={isMobile:navigator.userAgent.indexOf("iPhone")!==-1,index:0,posts:[],postsBySlug:{},imageCache:{},init:function(b,c){_.bindAll(this);this.path=c;this.posts=b;this.posts.reverse();_(this.posts).each(function(e,d){e.index=d;this.postsBySlug[e.slug]=e},this);if(this.path){this.preload(_(this.posts[this.index+1].photos).pluck("image_path"))}},bindResize:function(){if(!this.isMobile){$(window).resize(this.onResize)}},route:function(b){history.pushState(null,"","/"+b||"/");if(b.indexOf("p/")===0){b=b.substr(2)}this.path=b;$("body").removeClass();this.bindResize();this.render(b)},restoreScrollbar:function(){$("body").css("overflow","auto")},onResize:_.throttle(function(){window.clearTimeout(this.scrollbarHideTimeout);$("body").css("overflow","hidden");this.resize();this.scrollbarHideTimeout=window.setTimeout(this.restoreScrollbar,100)},50),calcViewportDimensions:function(){if(this.isMobile){return}var c=$(window).height(),b=$(window).width(),d=$("header").height()+$("footer").height()+22;this.maxHeight=c-d;this.viewportWidth=b},resize:function(){if(this.isMobile){return}var b=this;this.calcViewportDimensions();var c=function(){var g=$(this),e=g.width(),d=g.height(),f=b.maxHeight*(e/d);g.css({"max-height":b.maxHeight+"px","max-width":f+"px",width:""});if(e>b.viewportWidth){g.css({width:"100%"})}};$("#post").imagesLoaded().done(function(d){d.each(c)})},preload:function(b){var c=this;if(_(b).size()+_(this.imageCache).size()>8){this.imageCache={}}_(b).each(function(e){var d=$("<img />")[0];d.src="/"+e;this.imageCache[e]=d;$(d).load(_.bind(function(){if(!this.maxHeight){this.calcViewportDimensions()}if(!this.isMobile){var f=this.maxHeight*(d.width/d.height);$(this.imageCache[e]).css({"max-width":f+"px","max-height":this.maxHeight+"px"})}},this))},this)},onAddChildren:function(f,d){var c=window.MutationObserver||window.WebKitMutationObserver||window.MozMutationObserver,e=document.querySelector(f),b;if(!c){return}b=new c(function(g){g.forEach(function(h){if(h.addedNodes&&h.addedNodes.length){var i=h.addedNodes[0];if(i.complete){d()}else{$(i).load(d)}}})});b.observe(e,{attributes:true,childList:true,characterData:true});return b},insertTumblrButton:function(){var b={title:$("#title").text(),slug:$("#share").data("slug"),photos:[{image_path:$("#post img")[0].src}],tags:$("#share").data("tags")};$("#share").empty().append(this.tumblrButton(b))},tumblrButton:function(i){var g="http://"+window.location.host+"/",e=i.photos[0].image_path,b=e.indexOf(g)===-1?g+e:e,h=g+"p/"+i.slug,j='<a href="'+h+'">'+i.title+" by Lumilux</a>",k=i.tags&&i.tags.length?i.tags:"photography",d=window.encodeURIComponent,c="http://tumblr.com/share/photo?source="+d(b)+"&caption="+d(j)+"&clickthru="+d(h)+"&tags="+d(k),f="return !window.open(this.href, 'Share on Tumblr', 'width=400, height=400, centerscreen')";return'<a href="'+c+'" onclick="'+f+'" target="_blank" class="tumblr-button">Share on Tumblr</a>'},render:function(d){this.index=d?this.postsBySlug[d].index:0;var b=$("#post"),e=this.posts[this.index],c="http://"+window.location.host+"/";document.title=e.title+" - Lumilux";window.scrollTo(0,0);$('meta[name^="twitter"]').remove();b.empty();if(!this.isMobile){this.imgObserver=this.onAddChildren("#post",this.resize)}if(!this.maxHeight){this.calcViewportDimensions()}_(e.photos).each(function(g){var h=!this.isMobile?'style="width: auto; max-height: '+this.maxHeight+'px;"':"";var f='<img src="/'+g.image_path+'"'+h+" />";if(_(this.imageCache).has(g.image_path)){f=this.imageCache[g.image_path]}b.append(f)},this);$("#title").text(e.title);$("#date").show().text(e.date);$("#share").attr("data-slug",null);$("#share").attr("data-tags",null);$("#share").empty().append(this.tumblrButton(e));if(this.index===this.posts.length-1){$("#prev").hide()}else{if(!$("#prev").length){$("header ul").prepend('<li><a id="prev">&#x2190;</a></li>')}$("#prev").show().attr("href","/p/"+this.posts[this.index+1].slug);this.preload(_(this.posts[this.index+1].photos).pluck("image_path"))}if(this.index===0){$("#next").hide()}else{if(!$("#next").length){$("header ul").append('<li><a id="next">&#x2192;</a></li>')}$("#next").show().attr("href","/p/"+this.posts[this.index-1].slug);this.preload(_(this.posts[this.index-1].photos).pluck("image_path"))}}};$(function(){var b=window.location.pathname.substring(1);if(b==="archives"){$("#post dd").lazyload({threshold:600,onAppear:function(f){var e=$(this).find("noscript"),g=e[0],d=g.innerText.replace(/src=/g,"data-original="),c=$(d);c.each(function(){var h=$(this);h.attr("width",100).attr("height",100).attr("src","/img/g.gif").addClass("lazy-image")});$(this).append(c);e.remove();c.each(f)}});return}if(b&&b.indexOf("p/")===-1){return}a.resize();a.insertTumblrButton();$.ajax({url:"/content/posts.json",dataType:"json"}).done(function(c){a.init(c,b)}).fail(function(){});$(document).on("click","a[href^='/p']",function(c){if(!c.altKey&&!c.ctrlKey&&!c.metaKey&&!c.shiftKey&&(window.location.pathname==="/"||window.location.pathname.indexOf("/p/")===0)){c.preventDefault();a.route($(c.currentTarget).attr("href").replace(/^\//,""))}});$(document).on("keyup",function(c){var d=c.altKey||c.ctrlKey||c.metaKey||c.shiftKey||_([16,17,18,224]).contains(c.which);if(!d&&c.which===37){if($("#prev").is(":visible")){$("#prev").click()}}else{if(!d&&c.which===39){if($("#next").is(":visible")){$("#next").click()}}}})})}());
